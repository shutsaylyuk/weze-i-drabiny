<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Wƒô≈ºe i drabiny ‚Ä¢ Multiplayer</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <style>
    /* TWOJE LUDZIKI - NIERUSZANE */
    .pawn {
      width: 28px !important;
      height: 38px !important;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
      will-change: transform, left, top;
      z-index: 100 !important;
      opacity: 1 !important;
      visibility: visible !important;
      display: block !important;
    }

    .pawn::before, .pawn::after {
      content: "" !important;
      display: block !important;
      position: absolute !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
      background: radial-gradient(circle at 30% 30%, var(--p-light), var(--p-dark)) !important;
    }
    .pawn::before { top: 0; width: 40% !important; height: 40% !important; border-radius: 50% !important; }
    .pawn::after { bottom: 0; width: 100% !important; height: 55% !important; border-radius: 50% 50% 35% 35% !important; }

    .cell .pawn { position: absolute !important; }
    #start-zone .pawn { position: relative !important; flex: 0 0 auto; }

    /* PRZYWR√ìCENIE WYGLƒÑDU PLANSZY */
    .cell.magic { background-color: #fffce0 !important; }

    .target {
      position: absolute;
      bottom: 2px;
      right: 2px;
      font-size: 10px;
      font-weight: bold;
      color: #666;
      background: rgba(255,255,255,0.7);
      padding: 1px 3px;
      border-radius: 3px;
      z-index: 10;
    }

    /* CARD HIGHLIGHT Z TWOJEGO PLIKU */
    .card-highlight {
      margin-top: 15px;
      padding: 12px;
      border: 2px solid var(--accent);
      border-radius: 8px;
      background: rgba(var(--accent-rgb), 0.1);
    }

    .pawn.no-transition { transition: none !important; }
    .pawn.hidden { opacity: 0 !important; }
    .btn.loading { opacity: 0.5; pointer-events: none; }
    .disabled { pointer-events: none; opacity: 0.6; }
  </style>
</head>

<body>

<header class="app-header">
  <div class="brand">
    <div class="title">Wƒô≈ºe i drabiny</div>
    <div class="subtitle">Multiplayer ‚Ä¢ Pok√≥j: <b>{{ room.code }}</b></div>
  </div>

  <nav class="tabs">
    <a class="tab" href="/new?mode=hotseat&players=2">Hot-seat</a>
    <a class="tab" href="/new?mode=ai">Vs komputer</a>
    <a class="tab active" href="/mp">Multiplayer</a>
  </nav>

  <div class="actions">
    {% set my_player = room.players[my_idx] if my_idx is not none else none %}
    {% set is_my_turn = (room.turn|int == my_idx) %}
    {% set game_started = (room.players|length >= 2) %}

    <form action="/mp/room/{{ room.code }}/roll" method="post" id="roll-form">
      <button type="submit" id="roll-btn"
              class="btn {% if not can_roll or room.pending or not game_started or not is_my_turn %}disabled{% endif %}"
              {% if not can_roll or room.pending or not game_started or not is_my_turn %}disabled{% endif %}>
        üé≤ Rzuƒá
      </button>
    </form>
    <a class="btn" href="/mp">üö™ Lobby</a>
  </div>
</header>

<div class="layout">
  <aside class="info card">
    <div class="info-row">
        <b>Runda:</b> {{ ((room.move_count|int - 1) // (room.players|length)) + 1 if room.move_count|int > 0 else 1 }}
        | <b>Ruch:</b> {{ room.players[room.turn|int].name if room.players else "-" }}
    </div>

    {% if room.message %}
      <div class="spacer"></div>
      <div class="card" style="padding:10px;">{{ room.message }}</div>
    {% endif %}

    {% if my_player and my_player.card and my_player.card != "ANTY_WAZ" and not room.winner and not room.pending and is_my_turn and game_started %}
      <div class="card-highlight">
        <b>üÉè Twoja karta:</b> {{ my_player.card|replace('_', ' ') }}
        <form action="/mp/room/{{ room.code }}/use_card" method="post" style="margin-top:8px;">
          <button class="btn btn-sm" style="width:100%;">U≈ºyj karty</button>
        </form>
      </div>
    {% endif %}

    {% if room.pending and room.pending.type == "snake_choice" %}
      <div class="card-highlight" style="border-color: #ff4757; background: rgba(255, 71, 87, 0.1);">
        <b>üêç Decyzja na wƒô≈ºu:</b>
        {% if my_pid and room.pending.player_id == my_pid %}
          <p style="font-size:0.85em; margin: 8px 0;">Masz kartƒô ANTY WƒÑ≈ª. Co robisz?</p>
          <div style="display:flex; gap:8px;">
            <form action="/mp/room/{{ room.code }}/snake_decision" method="post" style="flex:1;">
              <input type="hidden" name="choice" value="stay">
              <button class="btn btn-sm" style="width:100%; background: #2ed573;">U≈ºyj karty</button>
            </form>
            <form action="/mp/room/{{ room.code }}/snake_decision" method="post" style="flex:1;">
              <input type="hidden" name="choice" value="back">
              <button class="btn secondary btn-sm" style="width:100%;">Spadnij</button>
            </form>
          </div>
        {% else %}
          <p style="font-size:0.85em; margin-top:8px;">Czekamy na decyzjƒô gracza...</p>
        {% endif %}
      </div>
    {% endif %}

    <div class="spacer"></div>
    <ul class="positions" id="posList">
      {% for p in room.players %}
        <li class="{% if room.turn|int == loop.index0 %}active-player{% endif %}">
          <span class="dot {{ p.color }}"></span>
          <span class="pname">{{ p.name }}{% if p.id == my_pid %} (Ty){% endif %}</span>
          <span class="ppos">pole: <b>{{ p.pos }}</b></span>
        </li>
      {% endfor %}
    </ul>

    <div class="history">
      <b>Historia:</b>
      <ul>
        {% for h in room.history|reverse %}<li>{{ h }}</li>{% endfor %}
      </ul>
    </div>
  </aside>

  <main>
    <div class="board-wrapper">
      <div class="start-box">
        <div class="start-title">START</div>
        <div class="start-pawns" id="start-zone">
          {% for p in room.players %}{% if p.pos|int == 0 %}
            <div class="pawn {{ p.color }} slot-{{ loop.index0 }}" data-player="{{ loop.index0 }}"></div>
          {% endif %}{% endfor %}
        </div>
      </div>

      <div class="board">
        {% for idx in range(100) %}
          {% set row = 9 - (idx // 10) %}{% set col = idx % 10 %}
          {% if row % 2 == 0 %}{% set n = row * 10 + col + 1 %}{% else %}{% set n = row * 10 + (10 - col) %}{% endif %}

          <div class="cell
            {% if (n|string in room.magic_tiles) and (room.magic_tiles[n|string] != 'USED') %}magic{% endif %}
            {% if n in snakes_ladders %}{{ 'ladder' if snakes_ladders[n] > n else 'snake' }}{% endif %}"
            data-n="{{ n }}">

            <span class="number">{{ n }}</span>

            {% if n in snakes_ladders %}
              <div class="center-icon">{{ 'ü™ú' if snakes_ladders[n] > n else 'üêç' }}</div>
              <div class="target">{{ snakes_ladders[n] }}</div>
            {% endif %}

            {% for pl in room.players %}{% if pl.pos|int == n and n > 0 %}
              <div class="pawn {{ pl.color }} slot-{{ loop.index0 }}" data-player="{{ loop.index0 }}"></div>
            {% endif %}{% endfor %}
          </div>
        {% endfor %}
      </div>
    </div>
  </main>
</div>

<script>
  const CONFIG = {
    stepDelay: 250,
    lastMove: {{ (room.last_move|tojson) if room.last_move else "null" }},
    version: {{ room.version or 0 }},
    playerCount: {{ room.players|length }},
    isPending: {{ 'true' if room.pending else 'false' }},
    isMyTurn: {{ 'true' if (room.turn|int == my_idx) else 'false' }},
    gameStarted: {{ 'true' if (room.players|length >= 2) else 'false' }},
    canRoll: {{ 'true' if can_roll else 'false' }}
  };

  const DOM = {
    cells: {},
    pawns: {},
    startZone: document.getElementById('start-zone'),
    rollBtn: document.getElementById('roll-btn'),
    form: document.getElementById('roll-form')
  };

  function updateCache() {
    document.querySelectorAll('.cell[data-n]').forEach(c => DOM.cells[c.dataset.n] = c);
    document.querySelectorAll('.pawn[data-player]').forEach(p => DOM.pawns[p.dataset.player] = p);
  }

  async function animate() {
    if (!CONFIG.lastMove) return;
    const { player, from, land, to, move_count } = CONFIG.lastMove;
    const key = `mp_final_anim_${move_count}_${player}`;

    if (sessionStorage.getItem(key)) return;
    sessionStorage.setItem(key, "1");

    updateCache();
    const pawn = DOM.pawns[player];
    if (!pawn) return;

    pawn.classList.add('no-transition', 'hidden');
    const startPos = from === 0 ? DOM.startZone : DOM.cells[from];
    if (startPos) startPos.appendChild(pawn);
    pawn.offsetHeight;
    pawn.classList.remove('no-transition', 'hidden');

    for (let i = from + 1; i <= land; i++) {
      const cell = DOM.cells[i];
      if (cell) {
        cell.appendChild(pawn);
        await new Promise(r => setTimeout(r, CONFIG.stepDelay));
      }
    }

    if (land !== to) {
      await new Promise(r => setTimeout(r, 450));
      const finalCell = DOM.cells[to];
      if (finalCell) finalCell.appendChild(pawn);
    }
  }

  async function checkServer() {
    try {
      const res = await fetch(`/mp/room/{{ room.code }}/state?t=${Date.now()}`);
      const data = await res.json();
      if (data.version > CONFIG.version || data.players.length !== CONFIG.playerCount) {
        window.location.reload();
      }
    } catch (e) {}
  }

  document.addEventListener("DOMContentLoaded", async () => {
    updateCache();
    if (DOM.rollBtn) DOM.rollBtn.classList.add('disabled');

    await animate();

    if (DOM.rollBtn && CONFIG.isMyTurn && CONFIG.gameStarted && !CONFIG.isPending && CONFIG.canRoll) {
        DOM.rollBtn.classList.remove('disabled');
        DOM.rollBtn.removeAttribute('disabled');
    }

    setInterval(checkServer, 2000);
  });
</script>
</body>
</html>