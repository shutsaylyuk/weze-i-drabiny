<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WÄ™Å¼e i drabiny â€¢ Multiplayer</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

<header class="app-header">
  <div class="brand">
    <div class="title">WÄ™Å¼e i drabiny</div>
    <div class="subtitle">Multiplayer â€¢ pokÃ³j <b>{{ room.code }}</b></div>
  </div>

  <nav class="tabs" aria-label="Tryby gry">
    <a class="tab" href="/new?mode=hotseat&players=2">Hot-seat</a>
    <a class="tab" href="/new?mode=ai">Vs komputer</a>
    <a class="tab active" href="/mp">Multiplayer</a>
  </nav>

  <div class="actions">
    {# RZUÄ† #}
    <form action="/mp/room/{{ room.code }}/roll" method="post" style="display:inline;">
      <button class="btn {% if not can_roll or room.pending %}disabled{% endif %}"
              {% if not can_roll or room.pending %}disabled{% endif %}>
        ğŸ² RzuÄ‡
      </button>
    </form>

    {# KARTA (tylko TELEPORT_PLUS3 ma przycisk) #}
    {% set my_card = None %}
    {% if my_idx is not none and room.players and my_idx < (room.players|length) %}
      {% set my_card = room.players[my_idx].card %}
    {% endif %}

    {% if my_pid and (not room.pending) and (not room.winner) and my_card and my_card == "TELEPORT_PLUS3" and (room.turn|int == my_idx) %}
      <form action="/mp/room/{{ room.code }}/use_card" method="post" style="display:inline;">
        <button class="btn secondary">ğŸƒ UÅ¼yj karty (TELEPORT +3)</button>
      </form>
    {% endif %}

    <a class="btn" href="/mp">ğŸšª Lobby</a>
  </div>
</header>

<div class="layout">
  <aside class="info card">
    <div class="info-row"><b>Kod pokoju:</b> {{ room.code }}</div>
    <div class="info-row"><b>TwÃ³j ID:</b> {{ my_pid or "brak (wejdÅº z lobby)" }}</div>

    {% set n_players = room.players|length %}
    {% set mc = room.move_count|int %}
    {% set round_num = 1 if mc == 0 else ((mc - 1) // n_players) + 1 %}

    <div class="info-row"><b>Runda:</b> {{ round_num }}</div>
    <div class="info-row">
      <b>Ruch:</b>
      {{ room.players[room.turn|int].name if room.players and room.turn is not none else "-" }}
    </div>

    <div class="spacer"></div>

    {% if room.message %}
      <div class="card" style="padding:10px;">{{ room.message }}</div>
    {% endif %}

    <div class="spacer"></div>

    <div class="info-row">
      <b>Twoja karta:</b>
      {% if my_card %}
        {{ my_card|replace("_"," ") }}
      {% else %}
        brak
      {% endif %}
    </div>

    {% if my_card == "ANTY_WAZ" %}
      <div class="muted" style="margin-top:6px;">
        ANTY WÄ„Å» aktywuje siÄ™ tylko, gdy staniesz na wÄ™Å¼u (wtedy pojawi siÄ™ decyzja).
      </div>
    {% endif %}

    {# PENDING: decyzja na wÄ™Å¼u (ANTY_WAZ) #}
    {% if room.pending and room.pending.type == "snake_choice" %}
      <div class="card" style="margin-top:12px; padding:12px;">
        <b>ğŸ WÄ…Å¼! Decyzja:</b>
        <div class="muted" style="margin-top:6px;">
          Stoisz na <b>{{ room.pending.from }}</b>.
          Normalnie spadasz na <b>{{ room.pending.to }}</b>.
        </div>

        {% if my_pid and room.pending.player_id == my_pid %}
          <div style="display:flex; gap:8px; margin-top:10px;">
            <form action="/mp/room/{{ room.code }}/snake_decision" method="post">
              <input type="hidden" name="choice" value="stay">
              <button class="btn">ğŸƒ ZostaÅ„ (ANTY WÄ„Å»)</button>
            </form>

            <form action="/mp/room/{{ room.code }}/snake_decision" method="post">
              <input type="hidden" name="choice" value="back">
              <button class="btn secondary">â¬‡ Cofnij siÄ™</button>
            </form>
          </div>
        {% else %}
          <div class="muted" style="margin-top:10px;">
            Czekamy na decyzjÄ™ gracza: {{ room.pending.player_id }}
          </div>
        {% endif %}
      </div>
    {% endif %}

    <div class="spacer"></div>

    <ul class="positions">
      {% for p in room.players %}
        <li>
          <span class="dot {{ p.color }}"></span>
          <span class="pname">{{ p.name }}{% if p.id == my_pid %} (Ty){% endif %}</span>
          <span class="ppos">pole: <b>{{ p.pos }}</b></span>
        </li>
      {% endfor %}
    </ul>

    <div class="spacer"></div>

    <div class="history">
      {% if room.history and room.history|length > 0 %}
        <ul>
          {% for h in room.history|reverse %}
            <li>{{ h }}</li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="muted">Brak ruchÃ³w jeszcze.</div>
      {% endif %}
    </div>
  </aside>

  <main>
    <div class="board-wrapper">

      <div class="start-box">
        <div class="start-title">START</div>
        <div class="start-pawns">
          {% for p in room.players %}
            {% if p.pos|int == 0 %}
              <div class="pawn {{ p.color }}" title="{{ p.name }}"></div>
            {% endif %}
          {% endfor %}
        </div>
      </div>

      <div class="board" aria-label="Plansza 10 na 10">
        {% set last_idx = room.last_player|int %}
        {% set mt = room.magic_tiles if room.magic_tiles else {} %}

        {% for idx in range(100) %}
          {% set row = idx // 10 %}
          {% set col = idx % 10 %}
          {% set r = 9 - row %}

          {% if (r % 2) == 0 %}
            {% set n = r*10 + col + 1 %}
          {% else %}
            {% set n = r*10 + (10 - col) %}
          {% endif %}

          {# magic_tiles klucze w JSON sÄ… stringami #}
          {% set key = n|string %}
          {% set mt_state = mt.get(key) %}

          <div class="cell
            {% if (key in mt) and (mt_state != "USED") %} magic {% endif %}
            {% if n in snakes_ladders %}
              {% if snakes_ladders[n] > n %} ladder {% else %} snake {% endif %}
            {% endif %}
            {% if room.players and (room.players[last_idx].pos|int == n) and (n > 0) %} highlight {% endif %}
          " data-n="{{ n }}">

            <span class="number">{{ n }}</span>

            {% if n in snakes_ladders %}
              {% if snakes_ladders[n] > n %}
                <div class="center-icon">ğŸªœ</div>
              {% else %}
                <div class="center-icon">ğŸ</div>
              {% endif %}
              <div class="target">{{ snakes_ladders[n] }}</div>
            {% endif %}

            {# pionki: slotowanie #}
            {% for pl in room.players %}
              {% if pl.pos|int == n and n > 0 %}
                <div class="pawn {{ pl.color }} slot-{{ loop.index0 }}" title="{{ pl.name }}"></div>
              {% endif %}
            {% endfor %}

          </div>
        {% endfor %}
      </div>

    </div>
  </main>
</div>

<script>
const code = "{{ room.code }}";

// JS tylko do przeÅ‚adowania strony, gdy coÅ› siÄ™ zmieni
function sig(st){
  return [
    st.move_count ?? 0,
    st.turn ?? 0,
    st.last_player ?? 0,
    st.last_roll ?? "",
    st.winner ?? "",
    JSON.stringify(st.pending ?? null),
    (st.message ?? ""),
    JSON.stringify(st.magic_tiles ?? null)
  ].join("|");
}

let lastSig = null;

async function poll(){
  const controller = new AbortController();
  const t = setTimeout(() => controller.abort(), 1200);

  try{
    const r = await fetch(`/mp/room/${code}/state`, {cache:"no-store", signal: controller.signal});
    const st = await r.json();
    const s = sig(st);

    if (lastSig === null) lastSig = s;
    else if (s !== lastSig){
      location.reload();
      return;
    }
  } catch(e) {
    // chwilowe przerwy ignorujemy
  } finally {
    clearTimeout(t);
  }

  setTimeout(poll, 1500);
}

poll();
</script>

</body>
</html>
