<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WÄ™Å¼e i drabiny</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css', v=move_count) }}">
  <style>

    .pawn {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
      will-change: transform, left, top;
      position: relative;
      z-index: 10;
    }
    .pawn.no-transition { transition: none !important; }
    .pawn.hidden { opacity: 0 !important; }
    .btn.loading { opacity: 0.5; pointer-events: none; }

    .cell.step .pawn { transform: none !important; }

    .card-action-box {
      margin-top: 15px;
      padding: 12px;
      border: 2px solid #3498db;
      border-radius: 8px;
      background: rgba(52, 152, 219, 0.1);
    }
  </style>
</head>

<body>

<header class="app-header">
  <div class="brand">
    <div class="title">WÄ™Å¼e i drabiny</div>
    <div class="subtitle">
      {% if mode == 'ai' %}Ty vs Komputer{% else %}Hot-seat â€¢ {{ players|length }} graczy{% endif %}
    </div>
  </div>

  <nav class="tabs" aria-label="Tryby gry">
    <a class="tab {% if mode=='hotseat' %}active{% endif %}" href="/new?mode=hotseat&players=2">Hot-seat</a>
    <a class="tab {% if mode=='ai' %}active{% endif %}" href="/new?mode=ai">Vs komputer</a>
    <a class="tab" href="/mp">Multiplayer</a>
  </nav>

  <div class="actions">
    {% set bot_turn = (mode == 'ai' and players[turn].get('is_bot')) %}
    {% set pending_active = (pending is not none) %}

    <a id="roll-btn" class="btn {% if won or bot_turn or pending_active %}disabled{% endif %}"
       href="javascript:void(0)"
       onclick="handleRoll(this)">ğŸ² RzuÄ‡</a>

    <a class="btn" href="/new?mode={{ mode }}&players={{ players|length }}">ğŸ”„ Nowa gra</a>
    <a class="btn secondary" href="/howto">ğŸ“˜ Instrukcja</a>
  </div>
</header>

<div class="layout">
  <aside class="info card">
    <div class="info-row"><b>Runda:</b> {{ round }} | <b>Ruch:</b> {{ players[turn].name }}</div>

    {% if message %}
      <div class="spacer"></div>
      <div class="card" style="padding:10px;">{{ message }}</div>
    {% endif %}

    {% if players[turn].card and not won and not bot_turn and not pending %}
      <div class="card-action-box">
        <b>ğŸƒ Karta:</b> {{ players[turn].card|replace('_', ' ') }}
        {% if players[turn].card != "ANTY_WAZ" %}
          <form action="/use_card" method="post" style="margin-top: 8px;">
            <button type="submit" class="btn btn-sm" style="width: 100%;">UÅ¼yj karty</button>
          </form>
        {% else %}
          <div style="font-size: 0.8em; color: #666; margin-top: 4px;">(Aktywuje siÄ™ automatycznie na wÄ™Å¼u)</div>
        {% endif %}
      </div>
    {% endif %}

    {% if mode != 'ai' and not won %}
      <div class="spacer"></div>
      <div class="info-row"><b>Liczba graczy:</b></div>
      <div class="player-count">
        {% for n in range(2, 5) %}
          <a class="btn {% if players|length == n %}active{% endif %}" href="/new?mode=hotseat&players={{ n }}">{{ n }}</a>
        {% endfor %}
      </div>
    {% endif %}

    <div class="spacer"></div>
    <ul class="positions">
      {% for p in players %}
        <li class="{% if turn == loop.index0 %}active-player{% endif %}">
          <span class="dot {{ p.color }}"></span>
          <span class="pname">{% if p.is_bot %}ğŸ¤–{% endif %} {{ p.name }}</span>
          <span class="ppos">pole: <b>{{ p.pos }}</b></span>
        </li>
      {% endfor %}
    </ul>

    {% if pending and pending.get("type") == "snake_choice" %}
      <div class="card" style="margin-top:12px; padding:12px; border: 2px solid orange;">
        <b>ğŸ Decyzja:</b>
        <p style="font-size: 0.85em; margin-bottom: 8px;">UÅ¼yÄ‡ karty ANTY WÄ„Å»?</p>
        <form action="/snake_decision" method="post" style="display:flex; gap:8px;">
          <button class="btn btn-sm" name="choice" value="stay">UÅ¼yj</button>
          <button class="btn secondary btn-sm" name="choice" value="back">Spadnij</button>
        </form>
      </div>
    {% endif %}

    <div class="spacer"></div>
    <div class="info-row"><b>Kolory pionkÃ³w:</b></div>
    <form class="colors-form" action="/set_colors" method="post">
      {% for p in players %}
        {% if not p.get('is_bot') %}
          <label class="color-row" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
            <span class="pname" style="font-size:0.9em;">{{ p.name }}</span>
            <select name="color_{{ loop.index0 }}" onchange="this.form.submit()">
              <option value="p-red" {% if p.color == "p-red" %}selected{% endif %}>Czerwony</option>
              <option value="p-blue" {% if p.color == "p-blue" %}selected{% endif %}>Niebieski</option>
              <option value="p-green" {% if p.color == "p-green" %}selected{% endif %}>Zielony</option>
              <option value="p-purple" {% if p.color == "p-purple" %}selected{% endif %}>Fioletowy</option>
            </select>
          </label>
        {% endif %}
      {% endfor %}
    </form>

    <div class="history">
      <b>Historia:</b>
      <ul>{% for h in history|reverse %}<li>{{ h }}</li>{% endfor %}</ul>
    </div>
  </aside>

  <main>
    <div class="board-wrapper">
      <div class="start-box">
        <div class="start-title">START</div>
        <div class="start-pawns" id="start-zone">
          {% for p in players %}{% if p.pos|int == 0 %}
            <div class="pawn {{ p.color }} slot-{{ loop.index0 }}" data-player="{{ loop.index0 }}"></div>
          {% endif %}{% endfor %}
        </div>
      </div>

      <div class="board">
        {% for idx in range(100) %}
          {% set row = 9 - (idx // 10) %}{% set col = idx % 10 %}
          {% if row % 2 == 0 %}{% set n = row * 10 + col + 1 %}{% else %}{% set n = row * 10 + (10 - col) %}{% endif %}

          <div class="cell {% if n in magic_tiles %}magic{% endif %} {% if n in snakes_ladders %}{{ 'ladder' if snakes_ladders[n] > n else 'snake' }}{% endif %}" data-n="{{ n }}">
            <span class="number">{{ n }}</span>
            {% if n in snakes_ladders %}
              <div class="center-icon">{{ 'ğŸªœ' if snakes_ladders[n] > n else 'ğŸ' }}</div>
              <div class="target">{{ snakes_ladders[n] }}</div>
            {% endif %}
            {% for pl in players %}{% if pl.pos|int == n and n > 0 %}
              <div class="pawn {{ pl.color }} slot-{{ loop.index0 }}" data-player="{{ loop.index0 }}"></div>
            {% endif %}{% endfor %}
          </div>
        {% endfor %}
      </div>
    </div>
  </main>
</div>

<script>
  const CONFIG = {
    stepDelay: 250,
    lastMove: {{ (last_move|tojson) if last_move else "null" }},
    isBotTurn: {{ "true" if bot_turn else "false" }},
    gameWon: {{ "true" if won else "false" }},
    isPending: {{ 'true' if pending else 'false' }}
  };

  let isAnimatingGlobal = false;

  const DOM = {
    cells: {},
    pawns: {},
    startZone: document.getElementById('start-zone'),
    rollBtn: document.getElementById('roll-btn')
  };

  function initCache() {
    document.querySelectorAll('.cell[data-n]').forEach(c => DOM.cells[c.dataset.n] = c);
    document.querySelectorAll('.pawn[data-player]').forEach(p => DOM.pawns[p.dataset.player] = p);
  }

  function handleRoll(btn) {
    if (btn.classList.contains('disabled') || isAnimatingGlobal) return;
    btn.classList.add('loading');
    window.location.href = "/roll";
  }

  async function animate() {
    if (!CONFIG.lastMove) return;
    const { player, from, land, to, move_count } = CONFIG.lastMove;
    const key = `fix_v112363_${move_count}_${player}`;

    if (sessionStorage.getItem(key)) return;
    sessionStorage.setItem(key, 'true');

    const pawn = DOM.pawns[player];
    if (!pawn) return;

    isAnimatingGlobal = true;


    const startCell = from === 0 ? DOM.startZone : DOM.cells[from];
    if (startCell) startCell.appendChild(pawn);

    pawn.offsetHeight;

    await new Promise(r => requestAnimationFrame(() => {
        pawn.classList.remove('no-transition');
        r();
    }));

    for (let i = from + 1; i <= land; i++) {
      const cell = DOM.cells[i];
      if (cell) {
        cell.appendChild(pawn);
        await new Promise(r => setTimeout(r, CONFIG.stepDelay));
      }
    }

    if (land !== to) {
      await new Promise(r => setTimeout(r, 450));
      const finalCell = DOM.cells[to];
      if (finalCell) finalCell.appendChild(pawn);
    }

    isAnimatingGlobal = false;
  }

  document.addEventListener("DOMContentLoaded", async () => {
    initCache();
    if (DOM.rollBtn) DOM.rollBtn.classList.add('disabled');
    await animate();

    if (DOM.rollBtn && !CONFIG.isBotTurn && !CONFIG.gameWon && !CONFIG.isPending) {
      DOM.rollBtn.classList.remove('disabled');
      DOM.rollBtn.classList.remove('loading');
    }

    if (CONFIG.isBotTurn && !CONFIG.gameWon) {
      setTimeout(() => window.location.href = "/ai_move", 600);
    }
  });
</script>
</body>
</html>