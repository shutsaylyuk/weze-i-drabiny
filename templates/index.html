<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WÄ™Å¼e i drabiny</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

<header class="app-header">
  <div class="brand">
    <div class="title">WÄ™Å¼e i drabiny</div>
    {% if mode == 'ai' %}
      <div class="subtitle">Ty vs Komputer</div>
    {% else %}
      <div class="subtitle">Hot-seat â€¢ {{ players|length }} graczy</div>
    {% endif %}
  </div>

  <nav class="tabs" aria-label="Tryby gry">
    <a class="tab {% if mode=='hotseat' %}active{% endif %}" href="/new?mode=hotseat&players=2">Hot-seat</a>
    <a class="tab {% if mode=='ai' %}active{% endif %}" href="/new?mode=ai">Vs komputer</a>
    <a class="tab" href="/mp">Multiplayer</a>
  </nav>

  <div class="actions">
    {% set bot_turn = (mode == 'ai' and players[turn].get('is_bot')) %}
    {% set pending_active = (pending is not none) %}

    {% if won or bot_turn or pending_active %}
      <a class="btn disabled" href="#" aria-disabled="true" title="{% if pending_active %}Najpierw podejmij decyzjÄ™ na wÄ™Å¼u{% endif %}">ğŸ² RzuÄ‡</a>
    {% else %}
      <a class="btn" href="/roll">ğŸ² RzuÄ‡</a>
    {% endif %}

    {% if mode == 'ai' %}
      <a class="btn" href="/new?mode=ai">ğŸ”„ Nowa gra</a>
    {% else %}
      <a class="btn" href="/new?mode=hotseat&players={{ players|length }}">ğŸ”„ Nowa gra</a>
    {% endif %}
    <a class="btn secondary" href="/howto">ğŸ“˜ Instrukcja</a>
  </div>
</header>

<div class="layout">
  <aside class="info card">
    <div class="info-row"><b>Runda:</b> {{ round }}</div>
    <div class="info-row"><b>Ruch:</b> {{ players[turn].name }}</div>

    {% if message %}
      <div class="spacer"></div>
      <div class="card" style="padding:10px;">
        {{ message }}
      </div>
    {% endif %}

    <div class="spacer"></div>

    {% if mode != 'ai' %}
      <div class="info-row"><b>Liczba graczy:</b></div>
      <div class="player-count">
        <a class="btn" href="/new?mode=hotseat&players=2">2</a>
        <a class="btn" href="/new?mode=hotseat&players=3">3</a>
        <a class="btn" href="/new?mode=hotseat&players=4">4</a>
      </div>
      <div class="spacer"></div>
    {% endif %}

    <ul class="positions">
      {% for p in players %}
        <li>
          <span class="dot {{ p.color }}"></span>
          <span class="pname">{{ p.name }}</span>
          <span class="ppos">pole: <b>{{ p.pos }}</b></span>
        </li>
      {% endfor %}
    </ul>

    <!-- ====== KARTY (HOTSEAT/AI) ====== -->
    <div class="spacer"></div>
    <div class="info-row"><b>Karta aktualnego gracza:</b></div>
    <div class="muted">
      {{ players[turn].name }} ma:
      <b>{{ players[turn].card if players[turn].card else "brak" }}</b>
    </div>

    {# UÅ¼ycie kart: tylko jeÅ›li NIE ma pending i NIE jest to bot turn i NIE ma wygranej #}
    {% if (players[turn].card) and (not pending) and (not won) and (not bot_turn) %}
      {% if players[turn].card != "ANTY_WAZ" %}
        <form action="/use_card" method="post" style="margin-top:8px;">
          <button class="btn" type="submit">ğŸƒ UÅ¼yj karty</button>
        </form>
      {% else %}
        <div class="muted" style="margin-top:6px;">
          (ANTY WÄ„Å» aktywuje siÄ™ tylko, gdy staniesz na wÄ™Å¼u)
        </div>
      {% endif %}
    {% endif %}

    {# Panel decyzji na wÄ™Å¼u (pending) #}
    {% if pending and pending.get("type") == "snake_choice" %}
      <div class="card" style="margin-top:12px; padding:12px;">
        <b>ğŸ WÄ…Å¼! Decyzja:</b>
        <div class="muted" style="margin-top:6px;">
          Stoisz na <b>{{ pending.get("from") }}</b>.
          Normalnie spadasz na <b>{{ pending.get("to") }}</b>.
        </div>

        <form action="/snake_decision" method="post" style="display:flex; gap:8px; margin-top:10px;">
          <button class="btn" name="choice" value="stay">ğŸƒ ZostaÅ„ (ANTY WÄ„Å»)</button>
          <button class="btn secondary" name="choice" value="back">â¬‡ Cofnij siÄ™</button>
        </form>
      </div>
    {% endif %}

    <!-- ====== KOLORY PIONKÃ“W ====== -->
    <div class="spacer"></div>
    <div class="info-row"><b>Kolory pionkÃ³w:</b></div>

    <form class="colors-form" action="/set_colors" method="post">
      {% for p in players %}
        {% if mode != 'ai' or not p.get('is_bot') %}
          <label class="color-row">
            <span class="dot {{ p.color }}"></span>
            <span class="pname">{{ p.name }}</span>

            <select name="color_{{ loop.index0 }}">
              <option value="p-red"    {% if p.color == "p-red" %}selected{% endif %}>Czerwony</option>
              <option value="p-blue"   {% if p.color == "p-blue" %}selected{% endif %}>Niebieski</option>
              <option value="p-green"  {% if p.color == "p-green" %}selected{% endif %}>Zielony</option>
              <option value="p-purple" {% if p.color == "p-purple" %}selected{% endif %}>Fioletowy</option>
            </select>
          </label>
        {% endif %}
      {% endfor %}

      <button class="btn" type="submit">Zapisz kolory</button>
    </form>

    <!-- ====== HISTORIA ====== -->
    <div class="history">
      {% if history and history|length > 0 %}
        <ul>
          {% for h in history|reverse %}
            <li>{{ h }}</li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="muted">Brak ruchÃ³w jeszcze.</div>
      {% endif %}
    </div>
  </aside>

  <main>
    <div class="board-wrapper">

      <!-- START BOX -->
      <div class="start-box">
        <div class="start-title">START</div>
        <div class="start-pawns">
          {% for p in players %}
            {% if p.pos|int == 0 %}
              <div class="pawn {{ p.color }}" title="{{ p.name }}"></div>
            {% endif %}
          {% endfor %}
        </div>
      </div>

      <!-- BOARD -->
      <div class="board" aria-label="Plansza 10 na 10">
        {% for idx in range(100) %}
          {% set row = idx // 10 %}
          {% set col = idx % 10 %}
          {% set r = 9 - row %}

          {% if (r % 2) == 0 %}
            {% set n = r*10 + col + 1 %}
          {% else %}
            {% set n = r*10 + (10 - col) %}
          {% endif %}

          <div class="cell
            {% if n in magic_tiles %} magic {%  endif %}
            {% if n in snakes_ladders %}
              {% if snakes_ladders[n] > n %} ladder {% else %} snake {% endif %}
            {% endif %}
            {% if n == players[last_player].pos|int and players[last_player].pos|int > 0 %} highlight {% endif %}
          ">
            <span class="number">{{ n }}</span>

            {% if n in snakes_ladders %}
              {% if snakes_ladders[n] > n %}
                <div class="center-icon">ğŸªœ</div>
              {% else %}
                <div class="center-icon">ğŸ</div>
              {% endif %}
              <div class="target">{{ snakes_ladders[n] }}</div>
            {% endif %}

            {# Pionki â€“ slotowanie, Å¼eby nie nachodziÅ‚y #}
            {% for pl in players %}
              {% if pl.pos|int == n and pl.pos|int > 0 %}
                <div class="pawn {{ pl.color }} slot-{{ loop.index0 }}" title="{{ pl.name }}"></div>
              {% endif %}
            {% endfor %}
          </div>
        {% endfor %}
      </div>

    </div>
  </main>
</div>

{% if mode == 'ai' and players[turn].get('is_bot') and not won %}
<script>
  setTimeout(function(){
    window.location.href = "/ai_move";
  }, 1000);
</script>
{% endif %}

</body>
</html>
